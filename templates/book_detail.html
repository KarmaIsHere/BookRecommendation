{% extends "base.html" %}

{% block title %}Home | Bookie{% endblock %}

{% block content %}
    <header>
        <h1>Book Detail</h1>
    </header>

    <div class="container">
        <div id="userBookInfo" class="user-book-info" style="display: none;">
            <p id="readingStatus"></p>
            <p id="score"></p>
        </div>
        <button id="addButton" class="btn">Add to List</button>
        <div class="book-container">
            <img id="bookImage" class="book-image" src="" alt="Book cover">
            <div>
                <h2 id="title">Loading...</h2>
                <p id="authors"></p>
                <div id="genres" class="genre-tags"></div>
                <p id="summary" class="summary"></p>
                <a id="textUrl" class="text-button" target="_blank">Read Full Text</a>
            </div>
        </div>
    </div>

    {% block scripts %}
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const bookId = {{ book_id | tojson }};
                const username = "{{ username }}";
                const api_link = "{{ api }}"
                const addButton = document.getElementById('addButton');


                axios.get(`${api_link}/api/user-book/${username}/${bookId}`)
                    .then(response => {
                        const userBook = response.data;

                        if (userBook.status || userBook.score !== undefined) {
                            document.getElementById('readingStatus').innerText = "Status: " + userBook.status;
                            document.getElementById('score').innerText = "Score: " + userBook.score + "/10";
                            document.getElementById('userBookInfo').style.display = "block";
                            addButton.remove();
                        }
                    })
                    .catch(err => {
                        console.log('User-book data not available for this book.');
                    });

                axios.get(`${api_link}/api/book/details/${bookId}`)
                    .then(response => {
                        const book = response.data;
                        document.getElementById('title').innerText = book.title;
                        document.getElementById('authors').innerText = "by " + book.authors.join(', ');
                        document.getElementById('summary').innerText = book.summary || "No summary available.";
                        document.getElementById('bookImage').src = book.image || "https://via.placeholder.com/200x300?text=No+Cover";
                        document.getElementById('textUrl').href = book.textUrl || "#";
                        document.getElementById('textUrl').style.display = book.textUrl ? "inline-block" : "none";

                        const genresDiv = document.getElementById('genres');
                        genresDiv.innerHTML = '';
                        book.genres.forEach(genre => {
                            const tag = document.createElement('span');
                            tag.classList.add('genre-tag');
                            tag.innerText = genre;
                            genresDiv.appendChild(tag);
                        });
                    })
                    .catch(err => {
                        document.querySelector('.container').innerHTML = '<p class="error">Book not found. Please try again later.</p>';
                        console.error('Error loading book:', err);
                    });

                addButton.addEventListener('click', function () {
                    const bookData = {
                        username: username,
                        bookId: bookId,
                        status: "PLAN_TO_READ",
                        score: 7,
                    };

                    axios.post(`${api_link}/api/user-book/create`, bookData)
                        .then(response => {
                            addButton.textContent = "Added!";
                            console.log("Book added to user list:", response.data);
                        })
                        .catch(error => {
                            console.error("Error adding book to list:", error);
                        });
                });
            });
        </script>
    {% endblock %}
{% endblock %}
